<template>
  <div class="app">
    <NuxtLayout name="default">
      <NuxtPage />
    </NuxtLayout>
  </div>
</template>

<script setup lang="ts">
const commonStore = useCommonStore();
const catalogStore = useCatalogStore();

const route = useRoute();
const router = useRouter();

const { lounges, pickupLocations } = storeToRefs(commonStore);
const { isShowProductModal, baseUrl } = storeToRefs(catalogStore);

await commonStore.loadSettings();
catalogStore.getCatalog();

useHead({
  link: [
    { rel: "stylesheet", href:"https://unpkg.com/zuck.js/dist/zuck.css" }, 
    { rel: "stylesheet", href:"https://unpkg.com/zuck.js/dist/skins/snapgram.css" }
  ],
  script: [
    { src: 'https://unpkg.com/zuck.js/dist/zuck.js' },
  ]
});

onMounted(() => {
  if (!commonStore.selectedLocation) {
    useChangeLocation('pickup', pickupLocations.value('pickup')[0]);
  }
})

watch(isShowProductModal, val => {
  if (!val) {
    if (baseUrl.value) {
      window.history.replaceState(null, '', baseUrl.value);
      return;
    } else {
      const pre = route.matched[0].path;
      const basePath = pre.split(':')[0];
      const uri = route.name === 'menu-categories-subcategory-product'
          ? `${route.params.categorySlug}/${route.params.subCategorySlug}` : `${route.params.categorySlug || ''}`;
      router.replace({path: `${basePath}${uri || ''}`});
    }
  }
});


commonStore.getPickups();
commonStore.getDelivery();
commonStore.getDeliveryTimes();
commonStore.getMenu();

commonStore.getBanners();

commonStore.getContacts();

</script>